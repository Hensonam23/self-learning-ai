#!/usr/bin/env python3
from __future__ import annotations
import compileall, sys, os, re, pathlib

ROOT = pathlib.Path(__file__).resolve().parents[1]

def main() -> int:
    # compile all py files except virtualenvs and site-packages
    rx = re.compile(r".*/(\.venv|venv|site-packages|\.git|build|dist)/")
    ok = compileall.compile_dir(str(ROOT), maxlevels=20, quiet=1, rx=rx)
    # quick import checks (must not run the app)
    critical = [
        "storage.memory",
        "audio.tts",
        "audio.audio_processing",
        "display.display_manager",
        "learning_shim",
        "network.network_server",
    ]
    for m in critical:
        try:
            __import__(m)
        except Exception as e:
            print(f"[SMOKE] import failed: {m}: {e}", file=sys.stderr)
            return 1
    return 0 if ok else 1

if __name__ == "__main__":
    sys.exit(main())
